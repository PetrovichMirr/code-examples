Архитектура приложения
======================

**Структура каталогов и файлов**

- **app** - основные файлы приложения
    - **Contracts** - основные интерфейсы
    - **Controllers** - контроллеры
    - **Core** - файлы ядра
    - **Models** - модели
    - **config.php** - конфигурация приложения
    - **routes.php** - маршруты (роуты)
- **public** - публично доступная директория
    - **index.php** - запуск приложения (единая точка входа)
- **resources** - файлы видов и другие ресурсы
    - **views** - файлы видов
- **vendor** - файлы composer`а и сторонние пакеты

В директории `public` размещаются файл запуска приложения `index.php`, а 
также файлы `.htaccess`, `robots.txt` и все остальные файлы, 
которые должны быть доступны публично (CSS, JS и т.п.).

**Жизненный цикл запроса**

При обработке входящего HTTP-запроса запускается файл `public/index.php`.
В нём определяются начальные параметры запуска (пути к основным директориям и файлам),
загружаются конфигурации приложения (`app/config.php` и переменные среды), 
подключается автозагручик `composer`. Затем управление передаётся 
методу `handle` экземпляра класса ядра `\App\Core\Kernel`.

В методе `handle` класса `\App\Core\Kernel` происходит обработка входящего запроса,
отправляется ответ приложения и завершается работа скрипта. 

***Рассмотрим подробнее код метода `\App\Core\Kernel::handle()`.***

Создаётся экземпляр класса `\App\Core\Request`, он выполняет обработку и хранение данных входящего запроса:

    // Обрабатываем входящий HTTP-запрос
    $request = request();
    $request->handle();

Загружаются маршруты (роуты) приложения, создаётся экземпляр класса `\App\Core\Route`:

    // Загружаем маршруты (роуты)
    require APP_PATH_FILE_ROUTES;

Основная задача класса `\App\Core\Route` - это задание соответствий вида 
`запрашиваемый URI = метод обработки`.
Класс `\App\Core\Route` на основании предоставляемых классом  `\App\Core\Request` 
данных о запросе (URI, метод) определяет обработчик этого запроса. 
Обработчик запроса представляет собой функцию обратного вызова (callback-функцию).
Обычно в качестве обработчика выступает метод контроллера.
Если обработчик не найден, это означает, что запрашиваемая страница не существует, 
в этом случае возвращается ответ с HTTP-кодом 404:

    // Определяем обработчик запроса
    $routeAction = route()->getAction($request->getUriPath(),
            $request->getMethod());

    // Проверяем наличие обработчика
    if (!isset($routeAction)) {
        response()->error(404);
    }

Если обработчик запроса найден, он выполняется.
Результат выполнения обработчика является ответом приложения, обычно это строка, 
содержащая HTML-код запрашиваемой страницы:

    // Вызываем обработчик и отправляем ответ приложения
    // Обработчик должен возвращать ответ (\App\Contracts\Response)
    // или данные для тела ответа
    $response = call_user_func($routeAction->getAction(),
            $routeAction->getParams());
    if ($response instanceof \App\Contracts\Response) {
        $response->send();
    } else {
        response()->setBody($response)->send();
    }

После отправки ответа приложение завершается:

    // Режим отладки
    if (APP_DEBUG) {
        echo 'Полное время работы скрипта: ',
        number_format((microtime(true) - APP_START), 6, '.', ' '),
        ' секунд.',
        ' Пиковое значение выделенного объема памяти: ',
        number_format(memory_get_peak_usage(true), 0, '.', ' '),
        ' байт';
    }
    exit;